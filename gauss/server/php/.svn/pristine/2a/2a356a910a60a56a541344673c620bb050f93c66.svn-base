<?php
namespace Plat\Websocket\Index;

use Lib\Websocket\Context;
use Lib\Config;
use Plat\Websocket\CheckLogin;

/*
 * 首页接口
 *
 */

class Index extends CheckLogin {
    public function onReceiveLogined(Context $context, Config $config)
    {

        $mysql = $config->data_analysis;
        $mysqlAdmin = $config->data_admin;
        $data = $context->getData();

        $date = isset($data["date"]) ? isset($data["date"]) : "";
        if(empty($date)){
            $date = "today";
        }

        if($date == "today"){
            $time = intval(date("Ymd",strtotime("today")));
            $sql = "select sum(user_all) as user_all,sum(user_register) as user_register,sum(user_first_deposit) as user_first_deposit,".
                "sum(user_active) as user_active,sum(bet_all) as bet_all,sum(bonus_all) as bonus_all,sum(profit_all) as profit_all ".
            "from daily_site where daily = ".$time;

            $site_sql = "select site_key,site_name,sum(user_all) as user_all,sum(user_register) as user_register,".
                "sum(user_first_deposit) as user_first_deposit,sum(user_active) as user_active,sum(bet_all) as bet_all,".
                "sum(bonus_all) as bonus_all,sum(profit_all) as profit_all,sum(bet_game) as bet_game,sum(bonus_game) as bonus_game,".
                "sum(bet_lottery) as bet_lottery, sum(bonus_lottery) as bonus_lottery ".
                "from daily_site where daily = ".$time." group by site_key,site_name";

            $rank_sql = "select site_key,site_name,bet_all from daily_site where daily =".$time." order by bet_all desc";
            foreach ($mysql->query($sql) as $row){
                $totalData = $row;
            }
            $siteData = iterator_to_array($mysql->query($site_sql));

            $rankData = [];
            foreach ($mysql->query($rank_sql) as $row){
                $rankData[] = $row;
            }

        }
        if($date == "yesterday"){
            $time = intval(date("Ymd",strtotime("yesterday")));
            $sql = "select sum(user_all) as user_all,sum(user_register) as user_register,sum(user_first_deposit) as user_first_deposit,".
                "sum(user_active) as user_active,sum(bet_all) as bet_all,sum(bonus_all) as bonus_all,sum(profit_all) as profit_all ".
                "from daily_site where daily = ".$time;

            $site_sql = "select site_key,site_name,sum(user_all) as user_all,sum(user_register) as user_register,".
                "sum(user_first_deposit) as user_first_deposit,sum(user_active) as user_active,sum(bet_all) as bet_all,".
                "sum(bonus_all) as bonus_all,sum(profit_all) as profit_all,sum(bet_game) as bet_game,sum(bonus_game) as bonus_game,".
                "sum(bet_lottery) as bet_lottery, sum(bonus_lottery) as bonus_lottery ".
                "from daily_site where daily = ".$time." group by site_key,site_name";

            $rank_sql = "select site_key,site_name,bet_all from daily_site where daily =".$time." order by bet_all desc";
            foreach ($mysql->query($sql) as $row){
                $totalData = $row;
            }
            $siteData = iterator_to_array($mysql->query($site_sql));

            $rankData = [];
            foreach ($mysql->query($rank_sql) as $row){
                $rankData[] = $row;
            }

        }
        if($date == "thisWeek"){
            $time = intval(date('oW', strtotime("today")));
            $sql = "select sum(user_all) as user_all,sum(user_register) as user_register,sum(user_first_deposit) as user_first_deposit,".
                "sum(user_active) as user_active,sum(bet_all) as bet_all,sum(bonus_all) as bonus_all,sum(profit_all) as profit_all ".
                "from weekly_site where weekly = ".$time;

            $site_sql = "select site_key,site_name,sum(user_all) as user_all,sum(user_register) as user_register,".
                "sum(user_first_deposit) as user_first_deposit,sum(user_active) as user_active,sum(bet_all) as bet_all,".
                "sum(bonus_all) as bonus_all,sum(profit_all) as profit_all,sum(bet_game) as bet_game,sum(bonus_game) as bonus_game,".
                "sum(bet_lottery) as bet_lottery, sum(bonus_lottery) as bonus_lottery ".
                "from weekly_site where weekly = ".$time." group by site_key,site_name";

            $rank_sql = "select site_key,site_name,bet_all from weekly_site where weekly =".$time." order by bet_all desc";
            foreach ($mysql->query($sql) as $row){
                $totalData = $row;
            }
            $siteData = iterator_to_array($mysql->query($site_sql));

            $rankData = [];
            foreach ($mysql->query($rank_sql) as $row){
                $rankData[] = $row;
            }
        }
        if($date == "LastWeek"){
            $time = intval(date("oW",strtotime("-2 week Monday"))) ;
            //$start_time = intval(date("Ymd ", mktime(0, 0, 0, date("m"), date("d") - date("w") + 1 - 7, date("Y"))));
            //$end_time = intval(date("Ymd ", mktime(23, 59, 59, date("m"), date("d") - date("w") + 7 - 7, date("Y"))));
            $sql = "select sum(user_all) as user_all,sum(user_register) as user_register,sum(user_first_deposit) as user_first_deposit,".
                "sum(user_active) as user_active,sum(bet_all) as bet_all,sum(bonus_all) as bonus_all,sum(profit_all) as profit_all ".
                "from weekly_site where weekly = ".$time;

            $site_sql = "select site_key,site_name,sum(user_all) as user_all,sum(user_register) as user_register,".
                "sum(user_first_deposit) as user_first_deposit,sum(user_active) as user_active,sum(bet_all) as bet_all,".
                "sum(bonus_all) as bonus_all,sum(profit_all) as profit_all,sum(bet_game) as bet_game,sum(bonus_game) as bonus_game,".
                "sum(bet_lottery) as bet_lottery, sum(bonus_lottery) as bonus_lottery ".
                "from weekly_site where weekly = ".$time." group by site_key,site_name";

            $rank_sql = "select site_key,site_name,bet_all from weekly_site where weekly =".$time." order by bet_all desc";
            foreach ($mysql->query($sql) as $row){
                $totalData = $row;
            }
            $siteData = iterator_to_array($mysql->query($site_sql));

            $rankData = [];
            foreach ($mysql->query($rank_sql) as $row){
                $rankData[] = $row;
            }
        }
        if($date == "thisMonth"){
            $time = intval(date("Ym",strtotime("today")));
            $sql = "select sum(user_all) as user_all,sum(user_register) as user_register,sum(user_first_deposit) as user_first_deposit,".
                "sum(user_active) as user_active,sum(bet_all) as bet_all,sum(bonus_all) as bonus_all,sum(profit_all) as profit_all ".
                "from monthly_site where monthly = ".$time;

            $site_sql = "select site_key,site_name,sum(user_all) as user_all,sum(user_register) as user_register,".
                "sum(user_first_deposit) as user_first_deposit,sum(user_active) as user_active,sum(bet_all) as bet_all,".
                "sum(bonus_all) as bonus_all,sum(profit_all) as profit_all,sum(bet_game) as bet_game,sum(bonus_game) as bonus_game,".
                "sum(bet_lottery) as bet_lottery, sum(bonus_lottery) as bonus_lottery ".
                "from monthly_site where monthly = ".$time." group by site_key,site_name";

            $rank_sql = "select site_key,site_name,bet_all from monthly_site where monthly =".$time." order by bet_all desc";
            foreach ($mysql->query($sql) as $row){
                $totalData = $row;
            }
            $siteData = iterator_to_array($mysql->query($site_sql));

            $rankData = [];
            foreach ($mysql->query($rank_sql) as $row){
                $rankData[] = $row;
            }
        }
        if($date == "LastMonth"){
            $time = intval(date("Ym",strtotime('last month')));
            $sql = "select sum(user_all) as user_all,sum(user_register) as user_register,sum(user_first_deposit) as user_first_deposit,".
                "sum(user_active) as user_active,sum(bet_all) as bet_all,sum(bonus_all) as bonus_all,sum(profit_all) as profit_all ".
                "from monthly_site where monthly = ".$time;

            $site_sql = "select site_key,site_name,sum(user_all) as user_all,sum(user_register) as user_register,".
                "sum(user_first_deposit) as user_first_deposit,sum(user_active) as user_active,sum(bet_all) as bet_all,".
                "sum(bonus_all) as bonus_all,sum(profit_all) as profit_all,sum(bet_game) as bet_game,sum(bonus_game) as bonus_game,".
                "sum(bet_lottery) as bet_lottery, sum(bonus_lottery) as bonus_lottery ".
                "from monthly_site where monthly = ".$time." group by site_key,site_name";

            $rank_sql = "select site_key,site_name,bet_all from monthly_site where monthly =".$time." order by bet_all desc";
            foreach ($mysql->query($sql) as $row){
                $totalData = $row;
            }
            $siteData = iterator_to_array($mysql->query($site_sql));

            $rankData = [];
            foreach ($mysql->query($rank_sql) as $row){
                $rankData[] = $row;
            }
        }
        $total_data = [
            "user_all"=>empty($totalData["user_all"]) ? 0 : $totalData["user_all"],
            "user_active"=>empty($totalData["user_active"]) ? 0 : $totalData["user_active"],
            "user_register"=>empty($totalData["user_register"]) ? 0 : $totalData["user_register"],
            "user_first_deposit"=>empty($totalData["user_first_deposit"]) ? 0 : $totalData["user_first_deposit"],
            "bet_all"=>empty($totalData["bet_all"]) ? 0 : $totalData["bet_all"],
            "profit_all"=>$totalData["bet_all"]-$totalData["bonus_all"],
        ];
        $sql = "select site_key,site_name from site";
        $site_list = iterator_to_array($mysqlAdmin->query($sql));
        $site = [];
        foreach ($siteData as $key=>$val){
            $site[$key]["site_key"] = $val["site_key"];
            $site[$key]["site_name"] = $val["site_name"];
            $site[$key]["user_all"] = empty($val["user_all"]) ? 0 : $val["user_all"];
            $site[$key]["user_active"] = empty($val["user_active"]) ? 0 : $val["user_active"];
            $site[$key]["user_register"] = empty($val["user_register"]) ? 0 : $val["user_register"];
            $site[$key]["user_first_deposit"] = empty($val["user_first_deposit"]) ? 0 : $val["user_first_deposit"];
            $site[$key]["bet_all"] = empty($val["bet_all"]) ? 0 : $val["bet_all"];
            $site[$key]["user_all"] = empty($val["user_all"]) ? 0 : $val["user_all"];
            $site[$key]["profit_all"] = $val["bet_all"]-$val["bonus_all"];
            $site[$key]["bet_lottery"] = empty($val["bet_lottery"]) ? 0 : $val["bet_lottery"];
            $site[$key]["profit_lottery"] = $val["bet_lottery"]-$val["bonus_lottery"];
            $site[$key]["bet_game"] = empty($val["bet_game"]) ? 0 : $val["bet_game"];
            $site[$key]["profit_game"] = $val["bet_game"]-$val["bonus_game"];
        }
        if(empty($site)){
            foreach ($site_list as $kk=>$vv){
                $site[$kk]["site_key"] = $vv["site_key"];
                $site[$kk]["site_name"] = $vv["site_name"];
                $site[$kk]["user_all"] = 0;
                $site[$kk]["user_active"] = 0;
                $site[$kk]["user_register"] = 0;
                $site[$kk]["user_first_deposit"] = 0;
                $site[$kk]["bet_all"] = 0;
                $site[$kk]["user_all"] = 0;
                $site[$kk]["profit_all"] = 0;
                $site[$kk]["bet_lottery"] = 0;
                $site[$kk]["profit_lottery"] = 0;
                $site[$kk]["bet_game"] = 0;
                $site[$kk]["profit_game"] = 0;
            }
        }
        $rank = [];
        if(!empty($rankData)){
            foreach ($rankData as $k=>$v){
                $rank[$k]["site_key"] = $v["site_key"];
                $rank[$k]["site_name"] = $v["site_name"];
                $rank[$k]["bet_all"] = empty($v["bet_all"]) ? 0 : $v["bet_all"];
            }
        }else{
           foreach ($site_list as $ks=>$vs){
               $rank[$ks]["site_key"] = $vs["site_key"];
               $rank[$ks]["site_name"] = $vs["site_name"];
               $rank[$ks]["bet_all"] = 0;
           }
        }
        $context->reply(["status"=>200,"msg"=>"获取成功","data"=>["totalData"=>$total_data,"siteData"=>$site,"rank"=>$rank]]) ;
    }
}